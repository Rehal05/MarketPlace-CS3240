{% load static tz %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reported Listings</title>
  <link rel="stylesheet" href="{% static 'login.css' %}">
</head>
<body class="page moderator-dashboard-page">

  <main class="content">

    <!-- Simple top bar / header for this page -->
    <header class="top-nav-bar">
      <div class="nav-inner">
        <div class="nav-left">
          <span class="nav-title">Reported Listings</span>
          <span class="nav-sub">
            Review and act on listings that users have reported.
          </span>
        </div>

        <nav class="nav-links">
          <a href="/accounts/moderator/dashboard/" class="btn btn-secondary">
            ‚Üê Back to Dashboard
          </a>
        </nav>
      </div>
    </header>

    <!-- Main card with reported listings -->
    <section class="card">
      <header class="card-header">
        <h2 class="card-title">All Reported Listings</h2>
        <p class="card-meta">
          Listings from the feed that have been reported by users.
        </p>
      </header>

      {% if reports %}
        <ul class="tool-list">
          {% for report in reports %}
            <li class="tool-item reported-item">
              <div class="tool-main">

                <!-- Post title -->
                <div class="tool-title">
                  {{ report.post.title }}
                </div>

                <!-- Optional image -->
                {% if report.post.image_url %}
                  <div style="margin: 0.35rem 0;">
                    <a href="{{ report.post.image_url }}" target="_blank">
                      <img src="{{ report.post.image_url }}"
                           alt="{{ report.post.title }}"
                           style="max-width: 180px; border-radius: 8px; border: 1px solid rgba(51,65,85,0.8);">
                    </a>
                  </div>
                {% endif %}

                <!-- Post description -->
                <div class="tool-description">
                  {% if report.post.description %}
                    {{ report.post.description }}
                  {% else %}
                    <em>No description provided for this listing.</em>
                  {% endif %}
                </div>

                <!-- Meta info -->
                <div class="report-meta" style="margin-top: 0.35rem; font-size: 0.8rem; color: var(--muted);">
                  <div>
                    <strong>Reported by:</strong>
                    {% if report.reported_by %}
                      {{ report.reported_by.username }} ({{ report.reported_by.email }})
                    {% else %}
                      <em>Unknown reporter</em>
                    {% endif %}
                  </div>

                  <div>
                    <strong>Post created:</strong>
                    {% if report.post.created_at %}
                      {{ report.post.created_at|timezone:"US/Eastern"|date:"M d, Y h:i A" }} (US/Eastern)
                    {% else %}
                      <em>Unknown time</em>
                    {% endif %}
                  </div>

                  <div>
                    <strong>Reported on:</strong>
                    {% if report.created_at %}
                      {{ report.created_at|timezone:"US/Eastern"|date:"M d, Y h:i A" }} (US/Eastern)
                    {% else %}
                      <em>Unknown time</em>
                    {% endif %}
                  </div>

                  <div>
                    <strong>Status:</strong>
                    {{ report.get_status_display }}
                  </div>

                  {% if report.reason %}
                    <div style="margin-top: 0.25rem;">
                      <strong>Reason:</strong>
                      <span>{{ report.reason }}</span>
                    </div>
                  {% endif %}

                  {% if report.post.price_min or report.post.price_max %}
                    <div style="margin-top: 0.25rem;">
                      <strong>Price:</strong>
                      {{ report.post.price_display }}
                    </div>
                  {% endif %}
                </div>
              </div>

              <!-- Actions -->
              <div class="tool-actions" style="display: flex; flex-direction: column; gap: 0.4rem;">

                <!-- Mark resolved -->
                <form method="post" action="{% url 'admin_reported_listings' %}" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  <input type="hidden" name="action" value="resolve">
                  <button type="submit" class="btn btn-secondary" style="font-size: 0.78rem;">
                    Mark Resolved
                  </button>
                </form>

                <!-- Delist listing -->
                <form method="post" action="{% url 'admin_reported_listings' %}" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  <input type="hidden" name="action" value="delist">
                  <button type="submit" class="btn btn-secondary" style="font-size: 0.78rem;">
                    Delist Listing
                  </button>
                </form>

                <!-- Ban user (backend must decide who to ban, e.g. owner if added later) -->
                <form method="post" action="{% url 'admin_reported_listings' %}" class="inline-form">
                  {% csrf_token %}
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  <input type="hidden" name="action" value="ban_user">
                  <button type="submit" class="btn btn-danger" style="font-size: 0.78rem;">
                    Ban User
                  </button>
                </form>

              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="empty-state">No reported listings at the moment. üéâ</p>
      {% endif %}
    </section>

  </main>

</body>
</html>
