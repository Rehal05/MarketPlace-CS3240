{% load static tz %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{% static 'login.css' %}">
</head>
<body class="page moderator-dashboard-page">

  <!-- Main content -->
  <main class="content">

    <!-- NAVIGATION BAR -->
    <header class="top-nav-bar">
      <div class="nav-inner">

        <div class="nav-left">
          <span class="nav-title">Moderator Dashboard</span>
          <span class="nav-sub">
            Signed in as {{ request.user.username }}
            {% if request.user.is_superuser %} · Superuser
            {% elif request.user.is_staff %} · Staff{% endif %}
          </span>
        </div>

        <nav class="nav-links">
          <a href="/" class="btn btn-secondary">View Site</a>

          {% if request.user.is_superuser %}
            <a href="{% url 'admin:index' %}" class="btn btn-secondary">Django Admin</a>
          {% endif %}

          <form method="post" action="{% url 'logout' %}" class="inline-form">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Logout</button>
          </form>
        </nav>

      </div>
    </header>

    <!-- ACCOUNT OVERVIEW -->
    <section class="card">
      <header class="card-header">
        <h2 class="card-title">Your Account</h2>
        <p class="card-meta">Moderator / Admin details</p>
      </header>

      <div class="account-grid">
        <div class="account-row">
          <span class="label">Username</span>
          <span class="value">{{ request.user.username }}</span>
        </div>

        {% if request.user.email %}
        <div class="account-row">
          <span class="label">Email</span>
          <span class="value">{{ request.user.email }}</span>
        </div>
        {% endif %}

        <div class="account-row">
          <span class="label">Role</span>
          <span class="value">
            {% if request.user.is_superuser %}
              Superuser (full access)
            {% elif request.user.is_staff %}
              Staff / Moderator
            {% else %}
              Regular user
            {% endif %}
          </span>
        </div>

        <div class="account-row">
          <span class="label">Last login</span>
          <span class="value">
            {% if request.user.last_login %}
              {{ request.user.last_login|timezone:"US/Eastern"|date:"M d, Y h:i A" }} (US/Eastern)
            {% else %}
              Never logged in before
            {% endif %}
          </span>
        </div>

        <div class="account-row">
          <span class="label">Account status</span>
          <span class="value">
            {% if request.user.is_active %}
              Active
            {% else %}
              Inactive
            {% endif %}
          </span>
        </div>
      </div>
    </section>

    <!-- SITE OVERVIEW -->
    <section class="card">
      <header class="card-header">
        <h2 class="card-title">Site Overview</h2>
        <p class="card-meta">High-level user statistics</p>
      </header>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Users</div>
          <div class="stat-value">
            {% if total_users is not None %}
              {{ total_users }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Staff / Moderators</div>
          <div class="stat-value">
            {% if total_staff is not None %}
              {{ total_staff }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Admins</div>
          <div class="stat-value">
            {% if total_admins is not None %}
              {{ total_admins }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">Active Users</div>
          <div class="stat-value">
            {% if total_active_users is not None %}
              {{ total_active_users }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card-actions">
        <a href="{% url 'user_list' %}" class="btn btn-primary">
          View All Users
        </a>
      </div>
    </section>

    <!-- MODERATION TOOLS -->
    <section class="card">
      <header class="card-header">
        <h2 class="card-title">Moderation Tools</h2>
        <p class="card-meta">Quick links for common tasks</p>
      </header>

      <ul class="tool-list">

        <!-- USER DIRECTORY -->
        <li class="tool-item">
          <div class="tool-main">
            <div class="tool-title">User Directory</div>
            <div class="tool-description">Browse all users, see types, and last login times.</div>
          </div>
          <div class="tool-actions">
            <a href="{% url 'user_list' %}" class="btn btn-secondary">Open</a>
          </div>
        </li>

        <!-- CONVERSATIONS -->
        <li class="tool-item">
          <div class="tool-main">
            <div class="tool-title">Conversations</div>
            <div class="tool-description">View all stored user conversations.</div>
          </div>
          <div class="tool-actions">
            <a href="{% url 'admin_conversations' %}" class="btn btn-secondary">Open</a>
          </div>
        </li>

        <!-- REPORTED LISTINGS -->
        <li class="tool-item">
          <div class="tool-main">
            <div class="tool-title">Reported Listings</div>
            <div class="tool-description">View all listings that users have reported for review.</div>
          </div>
          <div class="tool-actions">
            <a href="{% url 'admin_reports' %}" class="btn btn-secondary">Open</a>
          </div>
        </li>

        {% if request.user.is_superuser %}
        <li class="tool-item">
          <div class="tool-main">
            <div class="tool-title">Django Admin</div>
            <div class="tool-description">Full access to models, permissions, and advanced settings.</div>
          </div>
          <div class="tool-actions">
            <a href="{% url 'admin:index' %}" class="btn btn-secondary">Open</a>
          </div>
        </li>
        {% endif %}

      </ul>
    </section>

    <!-- NAV BAR ROUNDING SCRIPT -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
          const nav = document.querySelector(".top-nav-bar");
          if (!nav) return;

          const sentinel = document.createElement("div");
          sentinel.style.position = "absolute";
          sentinel.style.width = "1px";
          sentinel.style.height = "1px";
          sentinel.style.pointerEvents = "none";
          nav.parentNode.insertBefore(sentinel, nav);

          const observer = new IntersectionObserver(
            (entries) => {
              const entry = entries[0];
              if (entry.isIntersecting) {
                  nav.classList.remove("flush-top");
              } else {
                  nav.classList.add("flush-top");
              }
            },
            { threshold: 1.0 }
          );

          observer.observe(sentinel);
      });
    </script>

  </main>

</body>
</html>
